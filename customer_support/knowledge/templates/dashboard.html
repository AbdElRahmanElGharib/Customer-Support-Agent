{% extends 'base.html' %}

{% block title %}Chat Support{% endblock title %}

{% block extra_head %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        background: #fff;
        border-left: 1px solid var(--border-color);
        border-right: 1px solid var(--border-color);
    }

    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
    }

    .agent {
        align-self: flex-start;
        background: #e9ecef;
        color: #212529;
    }

    .user {
        align-self: flex-end;
        background: var(--primary-blue);
        color: white;
    }

    .input-area {
        padding: 20px;
        background: #fff;
        border-top: 1px solid var(--border-color);
    }

    .input-box {
        display: flex;
        gap: 10px;
    }

    input {
        flex: 1;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        outline: none;
    }

    button {
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 0 20px;
        border-radius: 6px;
        cursor: pointer;
    }

    @keyframes popBounce {
        0% {
            transform: scale(0.5);
            opacity: 0;
        }
        70% {
            transform: scale(1.05); /* The "Overshoot" */
            opacity: 1;
        }
        100% {
            transform: scale(1); /* Settling back */
        }
    }

    .message {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        
        /* Animation settings */
        animation: popBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
        transform-origin: bottom left; /* Agent messages pop from bottom-left */
    }

    .message.user {
        align-self: flex-end;
        background: var(--primary-blue);
        color: white;
        transform-origin: bottom right; /* User messages pop from bottom-right */
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="chat-container">
    <div class="messages-area">
        <div class="message agent">Hello! How can I assist you today?</div>
        
    </div>

    <div class="input-area">
        <form class="input-box">
            <input type="text" placeholder="Describe your issue...">
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<script>
    const chatForm = document.querySelector('.input-box');
    const messageInput = chatForm.querySelector('input');
    const chatWindow = document.querySelector('.messages-area');

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // 1. Append User Message
        appendMessage('user', message);
        messageInput.value = '';

        // 2. Show Typing Indicator
        const typingId = showTypingIndicator();

        // 3. Send to Django
        const formData = new FormData();
        formData.append('message', message);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById(typingId).remove(); // Remove typing indicator
            appendMessage('agent', data.response);
        });
    });
    
    function appendMessage(sender, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}`;
        msgDiv.innerText = text;
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTo({
            top: chatWindow.scrollHeight,
            behavior: 'smooth'
        });
    }

    function showTypingIndicator() {
        const id = 'typing-' + Date.now();
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message agent';
        typingDiv.id = id;
        typingDiv.innerHTML = '<i>...</i>';
        chatWindow.appendChild(typingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return id;
    }
</script>
{% endblock content %}
